<!doctype html><html lang=en><head><title>// willxwu</title><link rel="shortcut icon" href=/favicon.ico><meta charset=utf-8><meta name=generator content="Hugo 0.115.0"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="willxwu"><meta name=description content><link rel=stylesheet href=https://willxwu.github.io/css/main.min.68e582a4d4ed824d6b7e3b5b37cae47eb3779bd631046379d0e68b38230cc3e2.css><meta name=twitter:card content="summary"><meta name=twitter:title content><meta name=twitter:description content="Springboot整合seata分布式事务 一、创建seata日志表 -- 注意此处0.3.0+ 增加唯一索引 ux_undo_log CREATE TABLE `undo_log` ( `id` bigint(20) NOT NULL AUTO_INCREMENT, `branch_id` bigint(20) NOT NULL, `xid` varchar(100) NOT NULL, `context` varchar(128) NOT NULL, `rollback_info` longblob NOT NULL, `log_status` int(11) NOT NULL, `log_created` datetime NOT NULL, `log_modified` datetime NOT NULL, `ext` varchar(100) DEFAULT NULL, PRIMARY KEY (`id`), UNIQUE KEY `ux_undo_log` (`xid`,`branch_id`) ) ENGINE=InnoDB AUTO_INCREMENT=1 DEFAULT CHARSET=utf8; 二、安装事务协调器（seata-server） 1、下载地址
2、导入依赖
<dependency> <groupId>com.alibaba.cloud</groupId> <artifactId>spring-cloud-starter-alibaba-seata</artifactId> </dependency> 3、启动seata服务器
4、seata文件说明
registry.conf：注册中心配置。
这里执行注册中西为nacos。type = &ldquo;nacos&rdquo;，"><meta property="og:title" content><meta property="og:description" content="Springboot整合seata分布式事务 一、创建seata日志表 -- 注意此处0.3.0+ 增加唯一索引 ux_undo_log CREATE TABLE `undo_log` ( `id` bigint(20) NOT NULL AUTO_INCREMENT, `branch_id` bigint(20) NOT NULL, `xid` varchar(100) NOT NULL, `context` varchar(128) NOT NULL, `rollback_info` longblob NOT NULL, `log_status` int(11) NOT NULL, `log_created` datetime NOT NULL, `log_modified` datetime NOT NULL, `ext` varchar(100) DEFAULT NULL, PRIMARY KEY (`id`), UNIQUE KEY `ux_undo_log` (`xid`,`branch_id`) ) ENGINE=InnoDB AUTO_INCREMENT=1 DEFAULT CHARSET=utf8; 二、安装事务协调器（seata-server） 1、下载地址
2、导入依赖
<dependency> <groupId>com.alibaba.cloud</groupId> <artifactId>spring-cloud-starter-alibaba-seata</artifactId> </dependency> 3、启动seata服务器
4、seata文件说明
registry.conf：注册中心配置。
这里执行注册中西为nacos。type = &ldquo;nacos&rdquo;，"><meta property="og:type" content="article"><meta property="og:url" content="https://willxwu.github.io/posts/springboot/springboot%E6%95%B4%E5%90%88seata%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1/"><meta property="article:section" content="posts"></head><body><header class=app-header><a href=https://willxwu.github.io/><img class=app-header-avatar src=/avatar.jpg alt=willxwu></a><h1>willxwu</h1><p>生活哪有那么复杂，简单甚好。@万般滋味，皆是生活。</p><div class=app-header-social><a target=_blank href=https://github.com/willxwu rel="noreferrer noopener"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-github"><title>github</title><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a><a target=_blank href=https://twitter.com/i2school rel="noreferrer noopener"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-twitter"><title>twitter</title><path d="M23 3a10.9 10.9.0 01-3.14 1.53 4.48 4.48.0 00-7.86 3v1A10.66 10.66.0 013 4s-4 9 5 13a11.64 11.64.0 01-7 2c9 5 20 0 20-11.5a4.5 4.5.0 00-.08-.83A7.72 7.72.0 0023 3z"/></svg></a><a target=_blank href=https://twitter.com/willxwu rel="noreferrer noopener"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-umbrella"><title>umbrella</title><path d="M23 12A11.05 11.05.0 001 12zm-5 7a3 3 0 01-6 0v-7"/></svg></a></div></header><main class=app-container><article class=post><header class=post-header><h1 class=post-title></h1><div class=post-meta><div><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-calendar"><title>calendar</title><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>Jan 1, 0001</div><div><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-clock"><title>clock</title><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>4 min read</div></div></header><div class=post-content><h1 id=springboot整合seata分布式事务><strong>Springboot整合seata分布式事务</strong></h1><h1 id=一创建seata日志表>一、创建seata日志表</h1><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#75715e>-- 注意此处0.3.0+ 增加唯一索引 ux_undo_log
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TABLE</span> <span style=color:#f92672>`</span>undo_log<span style=color:#f92672>`</span> (
</span></span><span style=display:flex><span>  <span style=color:#f92672>`</span>id<span style=color:#f92672>`</span> bigint(<span style=color:#ae81ff>20</span>) <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>NULL</span> AUTO_INCREMENT,
</span></span><span style=display:flex><span>  <span style=color:#f92672>`</span>branch_id<span style=color:#f92672>`</span> bigint(<span style=color:#ae81ff>20</span>) <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>NULL</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>`</span>xid<span style=color:#f92672>`</span> varchar(<span style=color:#ae81ff>100</span>) <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>NULL</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>`</span>context<span style=color:#f92672>`</span> varchar(<span style=color:#ae81ff>128</span>) <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>NULL</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>`</span>rollback_info<span style=color:#f92672>`</span> longblob <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>NULL</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>`</span>log_status<span style=color:#f92672>`</span> int(<span style=color:#ae81ff>11</span>) <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>NULL</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>`</span>log_created<span style=color:#f92672>`</span> datetime <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>NULL</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>`</span>log_modified<span style=color:#f92672>`</span> datetime <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>NULL</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>`</span>ext<span style=color:#f92672>`</span> varchar(<span style=color:#ae81ff>100</span>) <span style=color:#66d9ef>DEFAULT</span> <span style=color:#66d9ef>NULL</span>,
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>PRIMARY</span> <span style=color:#66d9ef>KEY</span> (<span style=color:#f92672>`</span>id<span style=color:#f92672>`</span>),
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>UNIQUE</span> <span style=color:#66d9ef>KEY</span> <span style=color:#f92672>`</span>ux_undo_log<span style=color:#f92672>`</span> (<span style=color:#f92672>`</span>xid<span style=color:#f92672>`</span>,<span style=color:#f92672>`</span>branch_id<span style=color:#f92672>`</span>)
</span></span><span style=display:flex><span>) ENGINE<span style=color:#f92672>=</span>InnoDB AUTO_INCREMENT<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> <span style=color:#66d9ef>DEFAULT</span> CHARSET<span style=color:#f92672>=</span>utf8;
</span></span></code></pre></div><h1 id=二安装事务协调器seata-server>二、安装事务协调器（seata-server）</h1><p>1、<a href=https://github.com/seata/seata/releases>下载地址</a></p><p>2、导入依赖</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#f92672>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;groupId&gt;</span>com.alibaba.cloud<span style=color:#f92672>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;artifactId&gt;</span>spring-cloud-starter-alibaba-seata<span style=color:#f92672>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/dependency&gt;</span>
</span></span></code></pre></div><p>3、启动seata服务器</p><p>4、seata文件说明</p><p><strong>registry.conf</strong>：注册中心配置。</p><p>这里执行注册中西为nacos。type = &ldquo;nacos&rdquo;，</p><p>config {执行seata配置数据放在那里，这里默认使用文件放配置数据。 type = &ldquo;file&rdquo;</p><p><strong>file.conf</strong>：seata默认配置信息存放这里。</p><p>例如，事务日志存放地方配置</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span>## transaction log store, only used in server side
</span></span><span style=display:flex><span>store {
</span></span><span style=display:flex><span>  ## store mode: file、db
</span></span><span style=display:flex><span>  mode = &#34;file&#34;
</span></span><span style=display:flex><span>  ## file store property
</span></span><span style=display:flex><span>  file {
</span></span><span style=display:flex><span>    ## store location dir
</span></span><span style=display:flex><span>    dir = &#34;sessionStore&#34;
</span></span><span style=display:flex><span>    # branch session size , if exceeded first try compress lockkey, still exceeded throws exceptions
</span></span><span style=display:flex><span>    maxBranchSessionSize = 16384
</span></span><span style=display:flex><span>    # globe session size , if exceeded throws exceptions
</span></span><span style=display:flex><span>    maxGlobalSessionSize = 512
</span></span><span style=display:flex><span>    # file buffer size , if exceeded allocate new buffer
</span></span><span style=display:flex><span>    fileWriteBufferCacheSize = 16384
</span></span><span style=display:flex><span>    # when recover batch read size
</span></span><span style=display:flex><span>    sessionReloadReadSize = 100
</span></span><span style=display:flex><span>    # async, sync
</span></span><span style=display:flex><span>    flushDiskMode = async
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  ## database store property
</span></span><span style=display:flex><span>  db {
</span></span><span style=display:flex><span>    ## the implement of javax.sql.DataSource, such as DruidDataSource(druid)/BasicDataSource(dbcp) etc.
</span></span><span style=display:flex><span>    datasource = &#34;druid&#34;
</span></span><span style=display:flex><span>    ## mysql/oracle/postgresql/h2/oceanbase etc.
</span></span><span style=display:flex><span>    dbType = &#34;mysql&#34;
</span></span><span style=display:flex><span>    driverClassName = &#34;com.mysql.jdbc.Driver&#34;
</span></span><span style=display:flex><span>    ## if using mysql to store the data, recommend add rewriteBatchedStatements=true in jdbc connection param
</span></span><span style=display:flex><span>    url = &#34;jdbc:mysql://127.0.0.1:3306/seata?rewriteBatchedStatements=true&#34;
</span></span><span style=display:flex><span>    user = &#34;mysql&#34;
</span></span><span style=display:flex><span>    password = &#34;mysql&#34;
</span></span><span style=display:flex><span>    minConn = 5
</span></span><span style=display:flex><span>    maxConn = 30
</span></span><span style=display:flex><span>    globalTable = &#34;global_table&#34;
</span></span><span style=display:flex><span>    branchTable = &#34;branch_table&#34;
</span></span><span style=display:flex><span>    lockTable = &#34;lock_table&#34;
</span></span><span style=display:flex><span>    queryLimit = 100
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h1 id=三自定义代理数据源>三、自定义代理数据源</h1><p>**注意：所有想要用到分布式事务的微服务使用seata DataSourceProxy代理自己的数据源。**springboot默认使用的是Hikari数据源。</p><p><strong>DataSourceAutoConfiguration.java源代码：</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e>// Source code recreated from a .class file by IntelliJ IDEA
</span></span></span><span style=display:flex><span><span style=color:#75715e>// (powered by FernFlower decompiler)
</span></span></span><span style=display:flex><span><span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#f92672>package</span> org.springframework.boot.autoconfigure.jdbc<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> javax.sql.DataSource<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> javax.sql.XADataSource<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.boot.autoconfigure.condition.AnyNestedCondition<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.boot.autoconfigure.condition.ConditionMessage<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.boot.autoconfigure.condition.ConditionOutcome<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.boot.autoconfigure.condition.ConditionalOnClass<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.boot.autoconfigure.condition.ConditionalOnMissingBean<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.boot.autoconfigure.condition.ConditionalOnProperty<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.boot.autoconfigure.condition.SpringBootCondition<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.boot.autoconfigure.condition.ConditionMessage.Builder<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.boot.autoconfigure.jdbc.DataSourceConfiguration.Dbcp2<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.boot.autoconfigure.jdbc.DataSourceConfiguration.Generic<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.boot.autoconfigure.jdbc.DataSourceConfiguration.Hikari<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.boot.autoconfigure.jdbc.DataSourceConfiguration.OracleUcp<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.boot.autoconfigure.jdbc.DataSourceConfiguration.Tomcat<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.boot.autoconfigure.jdbc.DataSourceInitializationConfiguration.InitializationSpecificCredentialsDataSourceInitializationConfiguration<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.boot.autoconfigure.jdbc.DataSourceInitializationConfiguration.SharedCredentialsDataSourceInitializationConfiguration<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.boot.autoconfigure.jdbc.metadata.DataSourcePoolMetadataProvidersConfiguration<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.boot.context.properties.EnableConfigurationProperties<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.boot.jdbc.DataSourceBuilder<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.boot.jdbc.EmbeddedDatabaseConnection<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.context.annotation.Condition<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.context.annotation.ConditionContext<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.context.annotation.Conditional<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.context.annotation.Configuration<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.context.annotation.Import<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.context.annotation.ConfigurationCondition.ConfigurationPhase<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.core.env.Environment<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.core.type.AnnotatedTypeMetadata<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.jdbc.datasource.embedded.EmbeddedDatabaseType<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.util.StringUtils<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Configuration</span><span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>    proxyBeanMethods <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@ConditionalOnClass</span><span style=color:#f92672>({</span>DataSource<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>,</span> EmbeddedDatabaseType<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>})</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@ConditionalOnMissingBean</span><span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>    type <span style=color:#f92672>=</span> <span style=color:#f92672>{</span><span style=color:#e6db74>&#34;io.r2dbc.spi.ConnectionFactory&#34;</span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@EnableConfigurationProperties</span><span style=color:#f92672>({</span>DataSourceProperties<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>})</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Import</span><span style=color:#f92672>({</span>DataSourcePoolMetadataProvidersConfiguration<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>,</span> InitializationSpecificCredentialsDataSourceInitializationConfiguration<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>,</span> SharedCredentialsDataSourceInitializationConfiguration<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>})</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>DataSourceAutoConfiguration</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>DataSourceAutoConfiguration</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>EmbeddedDatabaseCondition</span> <span style=color:#66d9ef>extends</span> SpringBootCondition <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> String DATASOURCE_URL_PROPERTY <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;spring.datasource.url&#34;</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> SpringBootCondition pooledCondition <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> DataSourceAutoConfiguration<span style=color:#f92672>.</span><span style=color:#a6e22e>PooledDataSourceCondition</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        EmbeddedDatabaseCondition<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>public</span> ConditionOutcome <span style=color:#a6e22e>getMatchOutcome</span><span style=color:#f92672>(</span>ConditionContext context<span style=color:#f92672>,</span> AnnotatedTypeMetadata metadata<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            Builder message <span style=color:#f92672>=</span> ConditionMessage<span style=color:#f92672>.</span><span style=color:#a6e22e>forCondition</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;EmbeddedDataSource&#34;</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>new</span> Object<span style=color:#f92672>[</span><span style=color:#ae81ff>0</span><span style=color:#f92672>]);</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>hasDataSourceUrlProperty</span><span style=color:#f92672>(</span>context<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> ConditionOutcome<span style=color:#f92672>.</span><span style=color:#a6e22e>noMatch</span><span style=color:#f92672>(</span>message<span style=color:#f92672>.</span><span style=color:#a6e22e>because</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;spring.datasource.url is set&#34;</span><span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>anyMatches</span><span style=color:#f92672>(</span>context<span style=color:#f92672>,</span> metadata<span style=color:#f92672>,</span> <span style=color:#66d9ef>new</span> Condition<span style=color:#f92672>[]{</span><span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>pooledCondition</span><span style=color:#f92672>}))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> ConditionOutcome<span style=color:#f92672>.</span><span style=color:#a6e22e>noMatch</span><span style=color:#f92672>(</span>message<span style=color:#f92672>.</span><span style=color:#a6e22e>foundExactly</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;supported pooled data source&#34;</span><span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                EmbeddedDatabaseType type <span style=color:#f92672>=</span> EmbeddedDatabaseConnection<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>context<span style=color:#f92672>.</span><span style=color:#a6e22e>getClassLoader</span><span style=color:#f92672>()).</span><span style=color:#a6e22e>getType</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> type <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>?</span> ConditionOutcome<span style=color:#f92672>.</span><span style=color:#a6e22e>noMatch</span><span style=color:#f92672>(</span>message<span style=color:#f92672>.</span><span style=color:#a6e22e>didNotFind</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;embedded database&#34;</span><span style=color:#f92672>).</span><span style=color:#a6e22e>atAll</span><span style=color:#f92672>())</span> <span style=color:#f92672>:</span> ConditionOutcome<span style=color:#f92672>.</span><span style=color:#a6e22e>match</span><span style=color:#f92672>(</span>message<span style=color:#f92672>.</span><span style=color:#a6e22e>found</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;embedded database&#34;</span><span style=color:#f92672>).</span><span style=color:#a6e22e>items</span><span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> Object<span style=color:#f92672>[]{</span>type<span style=color:#f92672>}));</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>hasDataSourceUrlProperty</span><span style=color:#f92672>(</span>ConditionContext context<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            Environment environment <span style=color:#f92672>=</span> context<span style=color:#f92672>.</span><span style=color:#a6e22e>getEnvironment</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>environment<span style=color:#f92672>.</span><span style=color:#a6e22e>containsProperty</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;spring.datasource.url&#34;</span><span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>return</span> StringUtils<span style=color:#f92672>.</span><span style=color:#a6e22e>hasText</span><span style=color:#f92672>(</span>environment<span style=color:#f92672>.</span><span style=color:#a6e22e>getProperty</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;spring.datasource.url&#34;</span><span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>IllegalArgumentException var4<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>PooledDataSourceAvailableCondition</span> <span style=color:#66d9ef>extends</span> SpringBootCondition <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        PooledDataSourceAvailableCondition<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>public</span> ConditionOutcome <span style=color:#a6e22e>getMatchOutcome</span><span style=color:#f92672>(</span>ConditionContext context<span style=color:#f92672>,</span> AnnotatedTypeMetadata metadata<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            Builder message <span style=color:#f92672>=</span> ConditionMessage<span style=color:#f92672>.</span><span style=color:#a6e22e>forCondition</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;PooledDataSource&#34;</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>new</span> Object<span style=color:#f92672>[</span><span style=color:#ae81ff>0</span><span style=color:#f92672>]);</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> DataSourceBuilder<span style=color:#f92672>.</span><span style=color:#a6e22e>findType</span><span style=color:#f92672>(</span>context<span style=color:#f92672>.</span><span style=color:#a6e22e>getClassLoader</span><span style=color:#f92672>())</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>?</span> ConditionOutcome<span style=color:#f92672>.</span><span style=color:#a6e22e>match</span><span style=color:#f92672>(</span>message<span style=color:#f92672>.</span><span style=color:#a6e22e>foundExactly</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;supported DataSource&#34;</span><span style=color:#f92672>))</span> <span style=color:#f92672>:</span> ConditionOutcome<span style=color:#f92672>.</span><span style=color:#a6e22e>noMatch</span><span style=color:#f92672>(</span>message<span style=color:#f92672>.</span><span style=color:#a6e22e>didNotFind</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;supported DataSource&#34;</span><span style=color:#f92672>).</span><span style=color:#a6e22e>atAll</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>PooledDataSourceCondition</span> <span style=color:#66d9ef>extends</span> AnyNestedCondition <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        PooledDataSourceCondition<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>super</span><span style=color:#f92672>(</span>ConfigurationPhase<span style=color:#f92672>.</span><span style=color:#a6e22e>PARSE_CONFIGURATION</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>@Conditional</span><span style=color:#f92672>({</span>DataSourceAutoConfiguration<span style=color:#f92672>.</span><span style=color:#a6e22e>PooledDataSourceAvailableCondition</span><span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>})</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>PooledDataSourceAvailable</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            PooledDataSourceAvailable<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>@ConditionalOnProperty</span><span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>            prefix <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;spring.datasource&#34;</span><span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>            name <span style=color:#f92672>=</span> <span style=color:#f92672>{</span><span style=color:#e6db74>&#34;type&#34;</span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ExplicitType</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            ExplicitType<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Configuration</span><span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>        proxyBeanMethods <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Conditional</span><span style=color:#f92672>({</span>DataSourceAutoConfiguration<span style=color:#f92672>.</span><span style=color:#a6e22e>PooledDataSourceCondition</span><span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>})</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@ConditionalOnMissingBean</span><span style=color:#f92672>({</span>DataSource<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>,</span> XADataSource<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>})</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Import</span><span style=color:#f92672>({</span>Hikari<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>,</span> Tomcat<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>,</span> Dbcp2<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>,</span> OracleUcp<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>,</span> Generic<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>,</span> DataSourceJmxConfiguration<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>})</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>PooledDataSourceConfiguration</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>protected</span> <span style=color:#a6e22e>PooledDataSourceConfiguration</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Configuration</span><span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>        proxyBeanMethods <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Conditional</span><span style=color:#f92672>({</span>DataSourceAutoConfiguration<span style=color:#f92672>.</span><span style=color:#a6e22e>EmbeddedDatabaseCondition</span><span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>})</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@ConditionalOnMissingBean</span><span style=color:#f92672>({</span>DataSource<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>,</span> XADataSource<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>})</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Import</span><span style=color:#f92672>({</span>EmbeddedDataSourceConfiguration<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>})</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>EmbeddedDatabaseConfiguration</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>protected</span> <span style=color:#a6e22e>EmbeddedDatabaseConfiguration</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>导入很多数据源 @Import({Hikari.class, Tomcat.class, Dbcp2.class, OracleUcp.class, Generic.class, DataSourceJmxConfiguration.class})</p><p><strong>DataSourceConfiguration.java源代码</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Configuration</span><span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>        proxyBeanMethods <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@ConditionalOnClass</span><span style=color:#f92672>({</span>HikariDataSource<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>})</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@ConditionalOnMissingBean</span><span style=color:#f92672>({</span>DataSource<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>})</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@ConditionalOnProperty</span><span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>        name <span style=color:#f92672>=</span> <span style=color:#f92672>{</span><span style=color:#e6db74>&#34;spring.datasource.type&#34;</span><span style=color:#f92672>},</span>
</span></span><span style=display:flex><span>        havingValue <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;com.zaxxer.hikari.HikariDataSource&#34;</span><span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>        matchIfMissing <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Hikari</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        Hikari<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>@Bean</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>@ConfigurationProperties</span><span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>            prefix <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;spring.datasource.hikari&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>        HikariDataSource <span style=color:#a6e22e>dataSource</span><span style=color:#f92672>(</span>DataSourceProperties properties<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            HikariDataSource dataSource <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>HikariDataSource<span style=color:#f92672>)</span>DataSourceConfiguration<span style=color:#f92672>.</span><span style=color:#a6e22e>createDataSource</span><span style=color:#f92672>(</span>properties<span style=color:#f92672>,</span> HikariDataSource<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>StringUtils<span style=color:#f92672>.</span><span style=color:#a6e22e>hasText</span><span style=color:#f92672>(</span>properties<span style=color:#f92672>.</span><span style=color:#a6e22e>getName</span><span style=color:#f92672>()))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                dataSource<span style=color:#f92672>.</span><span style=color:#a6e22e>setPoolName</span><span style=color:#f92672>(</span>properties<span style=color:#f92672>.</span><span style=color:#a6e22e>getName</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> dataSource<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span></code></pre></div><p>自定义代理数据源配置：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>import</span> com.zaxxer.hikari.HikariDataSource<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> io.seata.rm.datasource.DataSourceProxy<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.beans.factory.annotation.Autowired<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.boot.autoconfigure.jdbc.DataSourceProperties<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.context.annotation.Bean<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.context.annotation.Configuration<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> org.springframework.util.StringUtils<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> javax.sql.DataSource<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @description: Seata自定义代理数据源
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @author: &lt;a href=&#34;mailto:batis@foxmail.com&#34;&gt;清风&lt;/a&gt;
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @date: 2022/3/12 14:41
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @version: 1.0
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Configuration</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>MySeataConfig</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Autowired</span>
</span></span><span style=display:flex><span>    DataSourceProperties dataSourceProperties<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Bean</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> DataSource <span style=color:#a6e22e>dataSource</span><span style=color:#f92672>(</span>DataSourceProperties dataSourceProperties<span style=color:#f92672>){</span>
</span></span><span style=display:flex><span>        HikariDataSource dataSource <span style=color:#f92672>=</span> dataSourceProperties<span style=color:#f92672>.</span><span style=color:#a6e22e>initializeDataSourceBuilder</span><span style=color:#f92672>().</span><span style=color:#a6e22e>type</span><span style=color:#f92672>(</span>HikariDataSource<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>).</span><span style=color:#a6e22e>build</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>StringUtils<span style=color:#f92672>.</span><span style=color:#a6e22e>hasText</span><span style=color:#f92672>(</span>dataSourceProperties<span style=color:#f92672>.</span><span style=color:#a6e22e>getName</span><span style=color:#f92672>()))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            dataSource<span style=color:#f92672>.</span><span style=color:#a6e22e>setPoolName</span><span style=color:#f92672>(</span>dataSourceProperties<span style=color:#f92672>.</span><span style=color:#a6e22e>getName</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> DataSourceProxy<span style=color:#f92672>(</span>dataSource<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h1 id=四复制seata配置文件到项目resources下>四、复制seata配置文件到项目resources下</h1><p>主要复制seata里面的模板文件file.conf、registry.conf</p><p><strong>注意：file.conf 的 service.vgroup_mapping 配置必须和<code>spring.application.name</code>一致</strong>。</p><p>vgroup_mapping.{应用名称}-fescar-service-group = &ldquo;default&rdquo;</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span>service{
</span></span><span style=display:flex><span>  vgroup_mapping.family-booking-fescar-service-group = &#34;default&#34;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>family-booking:微服务名字</p><p><strong>也可以通过配置 <code>spring.cloud.alibaba.seata.tx-service-group</code>修改后缀，但是必须和<code>file.conf</code>中的配置保持一致</strong></p><h1 id=五使用>五、使用</h1><p>在分布式事务入口方法加上全局事务注解@GlobalTransactional，远程调用方法上加本地事务注解@Transactional即可。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@GlobalTransactional</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Transactional</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> PageUtils <span style=color:#a6e22e>queryPage</span><span style=color:#f92672>(</span>Map<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>,</span> Object<span style=color:#f92672>&gt;</span> params<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>//调用远程方法，另一个微服务的方法加上小事务@Transactional
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h1 id=六使用场景><strong>六、使用场景</strong></h1><p><strong>不适用高并发的场景，适用普通的业务远程调用。seata默认是使用的AT模式。针对高并发场景还是的用柔性事务，消息队列、延迟队列，MQ中间件完成。</strong></p></div><div class=post-footer></div></article></main></body></html>