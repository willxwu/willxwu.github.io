<!doctype html><html lang=en-us><head><title>// willxwu</title><link rel="shortcut icon" href=/favicon.ico><meta charset=utf-8><meta name=generator content="Hugo 0.110.0"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="John Doe"><meta name=description content><link rel=stylesheet href=https://willxwu.github.io/css/main.min.68e582a4d4ed824d6b7e3b5b37cae47eb3779bd631046379d0e68b38230cc3e2.css><meta name=twitter:card content="summary"><meta name=twitter:title content><meta name=twitter:description content="适合当如缓存场景： 即时性、数据一致性要求不高的。 访问量大且更新频率不高的数据(读多，写少) 承担持久化工作。
读模式缓存使用流程: 凡是放入缓存中的数据，我们应该指定过期时间，使其可以再系统即使没有主动更新数据也能自动触发数据加载进缓存的流程。避免业务崩溃导致的数据永久不一致问题。
解决分布式缓存中本地缓存导致数据不一致问题，可以使用redis中间件解决。
springboot整合redis 1、引入springboot整合的start：pom文件引入依赖
<!--redis--> <dependency> <groupId>org.springframework.boot</groupId> <artifactId>spring-boot-starter-data-redis</artifactId> </dependency> 引入依赖之后就会有RedisAutoConfiguration，里面可以看的到redis的配置文件Redis.Properties.
@Configuration( proxyBeanMethods = false ) @ConditionalOnClass({RedisOperations.class}) @EnableConfigurationProperties({RedisProperties.class}) @Import({LettuceConnectionConfiguration.class, JedisConnectionConfiguration.class}) public class RedisAutoConfiguration { public RedisAutoConfiguration() { } @Bean @ConditionalOnMissingBean( name = {&#34;redisTemplate&#34;} ) @ConditionalOnSingleCandidate(RedisConnectionFactory.class) public RedisTemplate<Object, Object> redisTemplate(RedisConnectionFactory redisConnectionFactory) { RedisTemplate<Object, Object> template = new RedisTemplate(); template.setConnectionFactory(redisConnectionFactory); return template; } @Bean @ConditionalOnMissingBean @ConditionalOnSingleCandidate(RedisConnectionFactory.class) public StringRedisTemplate stringRedisTemplate(RedisConnectionFactory redisConnectionFactory) { return new StringRedisTemplate(redisConnectionFactory); } } Redis.Properties文件里面包含了redis的配置信息：
@ConfigurationProperties( prefix = &#34;spring."><meta property="og:title" content><meta property="og:description" content="适合当如缓存场景： 即时性、数据一致性要求不高的。 访问量大且更新频率不高的数据(读多，写少) 承担持久化工作。
读模式缓存使用流程: 凡是放入缓存中的数据，我们应该指定过期时间，使其可以再系统即使没有主动更新数据也能自动触发数据加载进缓存的流程。避免业务崩溃导致的数据永久不一致问题。
解决分布式缓存中本地缓存导致数据不一致问题，可以使用redis中间件解决。
springboot整合redis 1、引入springboot整合的start：pom文件引入依赖
<!--redis--> <dependency> <groupId>org.springframework.boot</groupId> <artifactId>spring-boot-starter-data-redis</artifactId> </dependency> 引入依赖之后就会有RedisAutoConfiguration，里面可以看的到redis的配置文件Redis.Properties.
@Configuration( proxyBeanMethods = false ) @ConditionalOnClass({RedisOperations.class}) @EnableConfigurationProperties({RedisProperties.class}) @Import({LettuceConnectionConfiguration.class, JedisConnectionConfiguration.class}) public class RedisAutoConfiguration { public RedisAutoConfiguration() { } @Bean @ConditionalOnMissingBean( name = {&#34;redisTemplate&#34;} ) @ConditionalOnSingleCandidate(RedisConnectionFactory.class) public RedisTemplate<Object, Object> redisTemplate(RedisConnectionFactory redisConnectionFactory) { RedisTemplate<Object, Object> template = new RedisTemplate(); template.setConnectionFactory(redisConnectionFactory); return template; } @Bean @ConditionalOnMissingBean @ConditionalOnSingleCandidate(RedisConnectionFactory.class) public StringRedisTemplate stringRedisTemplate(RedisConnectionFactory redisConnectionFactory) { return new StringRedisTemplate(redisConnectionFactory); } } Redis.Properties文件里面包含了redis的配置信息：
@ConfigurationProperties( prefix = &#34;spring."><meta property="og:type" content="article"><meta property="og:url" content="https://willxwu.github.io/posts/springboot/springboot%E6%95%B4%E5%90%88redis/"><meta property="article:section" content="posts"></head><body><header class=app-header><a href=https://willxwu.github.io/><img class=app-header-avatar src=/avatar.jpg alt="John Doe"></a><h1>willxwu</h1><nav class=app-header-menu><a class=app-header-menu-item href=/about/>about</a>
-
<a class=app-header-menu-item href=/>home</a>
-
<a class=app-header-menu-item href=/link/>link</a>
-
<a class=app-header-menu-item href=/tags/>tags</a></nav><p>I write code and I take care about my privacy // Co-founder @ Owaka // Golang lover // Open source enthusiast</p><div class=app-header-social><a target=_blank href=https://github.com/willxwu rel="noreferrer noopener"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-github"><title>github</title><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a><a target=_blank href=https://twitter.com/willxwu rel="noreferrer noopener"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-twitter"><title>twitter</title><path d="M23 3a10.9 10.9.0 01-3.14 1.53 4.48 4.48.0 00-7.86 3v1A10.66 10.66.0 013 4s-4 9 5 13a11.64 11.64.0 01-7 2c9 5 20 0 20-11.5a4.5 4.5.0 00-.08-.83A7.72 7.72.0 0023 3z"/></svg></a></div></header><main class=app-container><article class=post><header class=post-header><h1 class=post-title></h1><div class=post-meta><div><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-calendar"><title>calendar</title><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>Jan 1, 0001</div><div><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-clock"><title>clock</title><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>4 min read</div></div></header><div class=post-content><h1 id=适合当如缓存场景>适合当如缓存场景：</h1><ol><li>即时性、数据一致性要求不高的。</li><li>访问量大且更新频率不高的数据(读多，写少)</li></ol><p>承担持久化工作。</p><h1 id=读模式缓存使用流程>读模式缓存使用流程:</h1><p><img src=https://cdn.jsdelivr.net/gh/willxwu/CDN@main/images/202203031925978.png alt></p><p>凡是放入缓存中的数据，我们应该指定过期时间，使其可以再系统即使没有主动更新数据也能自动触发数据加载进缓存的流程。避免业务崩溃导致的数据永久不一致问题。</p><p>解决分布式缓存中本地缓存导致数据不一致问题，可以使用redis中间件解决。</p><h1 id=springboot整合redis>springboot整合redis</h1><p>1、引入springboot整合的start：pom文件引入依赖</p><pre tabindex=0><code class=language-xnl data-lang=xnl>        &lt;!--redis--&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-starter-data-redis&lt;/artifactId&gt;
        &lt;/dependency&gt;
</code></pre><p>引入依赖之后就会有RedisAutoConfiguration，里面可以看的到redis的配置文件Redis.Properties.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Configuration</span><span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>    proxyBeanMethods <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@ConditionalOnClass</span><span style=color:#f92672>({</span>RedisOperations<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>})</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@EnableConfigurationProperties</span><span style=color:#f92672>({</span>RedisProperties<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>})</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Import</span><span style=color:#f92672>({</span>LettuceConnectionConfiguration<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>,</span> JedisConnectionConfiguration<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>})</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>RedisAutoConfiguration</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>RedisAutoConfiguration</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Bean</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@ConditionalOnMissingBean</span><span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>        name <span style=color:#f92672>=</span> <span style=color:#f92672>{</span><span style=color:#e6db74>&#34;redisTemplate&#34;</span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@ConditionalOnSingleCandidate</span><span style=color:#f92672>(</span>RedisConnectionFactory<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> RedisTemplate<span style=color:#f92672>&lt;</span>Object<span style=color:#f92672>,</span> Object<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>redisTemplate</span><span style=color:#f92672>(</span>RedisConnectionFactory redisConnectionFactory<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        RedisTemplate<span style=color:#f92672>&lt;</span>Object<span style=color:#f92672>,</span> Object<span style=color:#f92672>&gt;</span> template <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> RedisTemplate<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        template<span style=color:#f92672>.</span><span style=color:#a6e22e>setConnectionFactory</span><span style=color:#f92672>(</span>redisConnectionFactory<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> template<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Bean</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@ConditionalOnMissingBean</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@ConditionalOnSingleCandidate</span><span style=color:#f92672>(</span>RedisConnectionFactory<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> StringRedisTemplate <span style=color:#a6e22e>stringRedisTemplate</span><span style=color:#f92672>(</span>RedisConnectionFactory redisConnectionFactory<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> StringRedisTemplate<span style=color:#f92672>(</span>redisConnectionFactory<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>Redis.Properties文件里面包含了redis的配置信息：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@ConfigurationProperties</span><span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>    prefix <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;spring.redis&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>RedisProperties</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>int</span> database <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> String url<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> String host <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;localhost&#34;</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> String username<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> String password<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>int</span> port <span style=color:#f92672>=</span> <span style=color:#ae81ff>6379</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>boolean</span> ssl<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> Duration timeout<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> Duration connectTimeout<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> String clientName<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> RedisProperties<span style=color:#f92672>.</span><span style=color:#a6e22e>ClientType</span> clientType<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> RedisProperties<span style=color:#f92672>.</span><span style=color:#a6e22e>Sentinel</span> sentinel<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> RedisProperties<span style=color:#f92672>.</span><span style=color:#a6e22e>Cluster</span> cluster<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> RedisProperties<span style=color:#f92672>.</span><span style=color:#a6e22e>Jedis</span> jedis <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> RedisProperties<span style=color:#f92672>.</span><span style=color:#a6e22e>Jedis</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> RedisProperties<span style=color:#f92672>.</span><span style=color:#a6e22e>Lettuce</span> lettuce <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> RedisProperties<span style=color:#f92672>.</span><span style=color:#a6e22e>Lettuce</span><span style=color:#f92672>();</span>
</span></span></code></pre></div><p>2、redis配置，可以根据上面的Redis.Properties类型，再applicatioin.yml中配置相关属性。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=display:flex><span><span style=color:#f92672>spring</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>redis</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>host</span>: <span style=color:#ae81ff>127.0.0.1</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>port</span>: <span style=color:#ae81ff>6379</span>
</span></span></code></pre></div><p>上面一个最简单的redis配置就完成了。</p><p>3、使用redis</p><p>由上面的RedisAutoConfiguration自动配置类，可以看到自动装配了RedisTemplate&lt;Object, Object>、StringRedisTemplate。</p><p>RedisTemplate&lt;Object, Object>：一般是字符串的Key，和序列化后的字符串value。</p><p>由于使用String类型的key、value较多，所以还提供了StringRedisTemplate。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>StringRedisTemplate</span> <span style=color:#66d9ef>extends</span> RedisTemplate<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>,</span> String<span style=color:#f92672>&gt;</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>StringRedisTemplate</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>setKeySerializer</span><span style=color:#f92672>(</span>RedisSerializer<span style=color:#f92672>.</span><span style=color:#a6e22e>string</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>setValueSerializer</span><span style=color:#f92672>(</span>RedisSerializer<span style=color:#f92672>.</span><span style=color:#a6e22e>string</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>setHashKeySerializer</span><span style=color:#f92672>(</span>RedisSerializer<span style=color:#f92672>.</span><span style=color:#a6e22e>string</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>setHashValueSerializer</span><span style=color:#f92672>(</span>RedisSerializer<span style=color:#f92672>.</span><span style=color:#a6e22e>string</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>StringRedisTemplate</span><span style=color:#f92672>(</span>RedisConnectionFactory connectionFactory<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>setConnectionFactory</span><span style=color:#f92672>(</span>connectionFactory<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>afterPropertiesSet</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>protected</span> RedisConnection <span style=color:#a6e22e>preProcessConnection</span><span style=color:#f92672>(</span>RedisConnection connection<span style=color:#f92672>,</span> <span style=color:#66d9ef>boolean</span> existingConnection<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> DefaultStringRedisConnection<span style=color:#f92672>(</span>connection<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>StringRedisTemplate也是继承了RedisTemplate&lt;String, String>，都是字符串的key,value.</p><p><strong>this.setKeySerializer(RedisSerializer.string());</strong>
<strong>this.setValueSerializer(RedisSerializer.string());</strong>
<strong>this.setHashKeySerializer(RedisSerializer.string());</strong>
<strong>this.setHashValueSerializer(RedisSerializer.string());</strong></p><p>上面的key、value都是用RedisSerializer.string()类型序列化。</p><p>使用配置好的StringRedisTemplate。</p><p>StringRedisTemplate的value由多种不同类型的值。</p><p><img src=https://cdn.jsdelivr.net/gh/willxwu/CDN@main/images/202203032001123.png alt></p><p>保存获取值：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>    <span style=color:#a6e22e>@Test</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>testStringRedisTemplate</span><span style=color:#f92672>(){</span>
</span></span><span style=display:flex><span>        ValueOperations<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>,</span> String<span style=color:#f92672>&gt;</span> opsForValue <span style=color:#f92672>=</span> stringRedisTemplate<span style=color:#f92672>.</span><span style=color:#a6e22e>opsForValue</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        opsForValue<span style=color:#f92672>.</span><span style=color:#a6e22e>set</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;hello&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;world&#34;</span><span style=color:#f92672>+</span> UUID<span style=color:#f92672>.</span><span style=color:#a6e22e>randomUUID</span><span style=color:#f92672>().</span><span style=color:#a6e22e>toString</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>        String hello <span style=color:#f92672>=</span> opsForValue<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;hello&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;之前保存值为:&#34;</span><span style=color:#f92672>+</span>hello<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span></code></pre></div><p>输出结果:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>之前保存值为</span><span style=color:#f92672>:</span>world1e9f395e<span style=color:#f92672>-</span><span style=color:#ae81ff>67</span>b8<span style=color:#f92672>-</span><span style=color:#ae81ff>4077</span><span style=color:#f92672>-</span><span style=color:#ae81ff>9912</span><span style=color:#f92672>-</span>c690c7da0f06
</span></span></code></pre></div><p>redis数据库的值：</p><p><img src=https://cdn.jsdelivr.net/gh/willxwu/CDN@main/images/202203032010191.png alt></p><p>注意保存获取时，key必须是一样的。</p><p>value一般是序列化后的json字符串，因为json字符串是跨语言跨平台的。vlaue存复杂对象时，序列化可以用alibaba的fastjson。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>Map<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>,</span>List<span style=color:#f92672>&lt;</span>UserEntity<span style=color:#f92672>&gt;&gt;</span> data<span style=color:#960050;background-color:#1e0010>：要存入</span>redis<span style=color:#960050;background-color:#1e0010>的复杂数据，通过序列化后存在</span>redis<span style=color:#960050;background-color:#1e0010>。</span>
</span></span><span style=display:flex><span>String  s <span style=color:#f92672>=</span> JSON<span style=color:#f92672>.</span><span style=color:#a6e22e>toJSONString</span><span style=color:#f92672>(</span>data<span style=color:#f92672>)</span><span style=color:#960050;background-color:#1e0010>；</span>
</span></span><span style=display:flex><span>ValueOperations<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>,</span> String<span style=color:#f92672>&gt;</span> ops <span style=color:#f92672>=</span> redisTemplate<span style=color:#f92672>.</span><span style=color:#a6e22e>opsForValue</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>ops<span style=color:#f92672>.</span><span style=color:#a6e22e>set</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;mydata&#34;</span><span style=color:#f92672>,</span>s<span style=color:#f92672>);</span>
</span></span></code></pre></div><p>同样获取的json数据也需要反序列化后才能使用：比如转化成一个复杂数据格式</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>String jsonStr<span style=color:#f92672>=</span> ops<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;mydata&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>Map<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>,</span>List<span style=color:#f92672>&lt;</span>UserEntity<span style=color:#f92672>&gt;&gt;</span> result <span style=color:#f92672>=</span> JSON<span style=color:#f92672>.</span><span style=color:#a6e22e>parseObject</span><span style=color:#f92672>(</span>jsonStr<span style=color:#f92672>,</span> <span style=color:#66d9ef>new</span> TypeReference<span style=color:#f92672>&lt;</span>Map<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>,</span>List<span style=color:#f92672>&lt;</span>UserEntity<span style=color:#f92672>&gt;&gt;&gt;()</span> <span style=color:#f92672>{});</span>
</span></span></code></pre></div><p>注意:</p><p>springboot2.0后默认使用lettuce作为操作redis的客户端，使用netty进行网络通信。但是lettuce的bug导致netty容易堆外内存溢出。netty如果没有指定堆外内存，默认使用-Xmx300m。可以通过-Dio.netty.maxDirectMemory设置堆外内存大小，但是始终会出现堆外内存溢出。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>incrementMemoryCounter</span><span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> capacity<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>DIRECT_MEMORY_COUNTER <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>long</span> newUsedMemory <span style=color:#f92672>=</span> DIRECT_MEMORY_COUNTER<span style=color:#f92672>.</span><span style=color:#a6e22e>addAndGet</span><span style=color:#f92672>((</span><span style=color:#66d9ef>long</span><span style=color:#f92672>)</span>capacity<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>newUsedMemory <span style=color:#f92672>&gt;</span> DIRECT_MEMORY_LIMIT<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                DIRECT_MEMORY_COUNTER<span style=color:#f92672>.</span><span style=color:#a6e22e>addAndGet</span><span style=color:#f92672>((</span><span style=color:#66d9ef>long</span><span style=color:#f92672>)(-</span>capacity<span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> OutOfDirectMemoryError<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;failed to allocate &#34;</span> <span style=color:#f92672>+</span> capacity <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34; byte(s) of direct memory (used: &#34;</span> <span style=color:#f92672>+</span> <span style=color:#f92672>(</span>newUsedMemory <span style=color:#f92672>-</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>long</span><span style=color:#f92672>)</span>capacity<span style=color:#f92672>)</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;, max: &#34;</span> <span style=color:#f92672>+</span> DIRECT_MEMORY_LIMIT <span style=color:#f92672>+</span> <span style=color:#e6db74>&#39;)&#39;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span></code></pre></div><p>解决方案：不能只用-Dio.netty.maxDirectMemory去调大内存。</p><p>1、升级netty客户端。</p><p>2、切换使用jedis</p><h1 id=如何使用jedis>如何使用jedis</h1><p><img src=https://cdn.jsdelivr.net/gh/willxwu/CDN@main/images/202203032043686.png alt></p><p>redis默认使用的是lettuce，因此需要排除掉lettuce，引入jedis。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span>        <span style=color:#75715e>&lt;!--引入redis--&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>&lt;groupId&gt;</span>org.springframework.boot<span style=color:#f92672>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>&lt;artifactId&gt;</span>spring-boot-starter-data-redis<span style=color:#f92672>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>&lt;exclusions&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>&lt;exclusion&gt;</span><span style=color:#75715e>&lt;!--排除lettuce--&gt;</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>&lt;groupId&gt;</span>io.lettuce<span style=color:#f92672>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>&lt;artifactId&gt;</span>lettuce-core<span style=color:#f92672>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>&lt;/exclusion&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>&lt;/exclusions&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>&lt;/dependency&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>&lt;!--引入jedis--&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>&lt;groupId&gt;</span>redis.clients<span style=color:#f92672>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>&lt;artifactId&gt;</span>jedis<span style=color:#f92672>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>&lt;/dependency&gt;</span>
</span></span></code></pre></div><p>lettuce、jedis都是操作redis的底层客户端。RedisTemplate是对lettuce、jedis对redis操作的再次封装，以后操作都可以用RedisTemplate进行操作redis。</p><p>通过redis的自动装配可以看到是引入了lettuce，jedis的。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Import</span><span style=color:#f92672>({</span>LettuceConnectionConfiguration<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>,</span> JedisConnectionConfiguration<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>})</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>RedisAutoConfiguration</span> <span style=color:#f92672>{</span>
</span></span></code></pre></div><p>通过jedis可以看到。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>JedisConnectionConfiguration</span> <span style=color:#66d9ef>extends</span> RedisConnectionConfiguration <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    JedisConnectionConfiguration<span style=color:#f92672>(</span>RedisProperties properties<span style=color:#f92672>,</span> ObjectProvider<span style=color:#f92672>&lt;</span>RedisSentinelConfiguration<span style=color:#f92672>&gt;</span> sentinelConfiguration<span style=color:#f92672>,</span> ObjectProvider<span style=color:#f92672>&lt;</span>RedisClusterConfiguration<span style=color:#f92672>&gt;</span> clusterConfiguration<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>super</span><span style=color:#f92672>(</span>properties<span style=color:#f92672>,</span> sentinelConfiguration<span style=color:#f92672>,</span> clusterConfiguration<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Bean</span>
</span></span><span style=display:flex><span>    JedisConnectionFactory <span style=color:#a6e22e>redisConnectionFactory</span><span style=color:#f92672>(</span>ObjectProvider<span style=color:#f92672>&lt;</span>JedisClientConfigurationBuilderCustomizer<span style=color:#f92672>&gt;</span> builderCustomizers<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>createJedisConnectionFactory</span><span style=color:#f92672>(</span>builderCustomizers<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span></code></pre></div><p>无论是lettuce、jedis最后都会注入JedisConnectionFactory，就是redis要用的。</p><h1 id=高并发下缓存失效问题-缓存穿透>高并发下缓存失效问题-缓存穿透：</h1><p>缓存穿透：</p><p>指查询一个一定不存的数据，由于缓存是不命中，将去查询数据库，但是数据库也没有此记录，我们将这此查询的null写入缓存，这将导致这个不存在的数据每次请求都要到存储层查询，失去了缓存的意义。</p><p>风险：利用不存在的数据进行攻击，，数据库瞬时压力增大，最终导致崩溃。</p><p>解决方案：null结果也缓存到redis，并加入短暂的过期时间。</p><h1 id=高并发下缓存失效-缓存雪崩>高并发下缓存失效-缓存雪崩</h1><p>缓存雪崩：指在我们设置缓存时key采用了相同的过期时间，导致缓存在某一时间同时失效，请求全部转发到DB，DB瞬时压力过大雪崩。</p><p>解决方案：原有的失效时间基础上增加一个随机值，比如11-5分分钟随机，这样每一个缓存的过期时间重复概率就会降低，很难引发集体失效。</p><h1 id=高并发下缓存失效问题-缓存击穿>高并发下缓存失效问题-缓存击穿</h1><p>缓存穿透：</p><p>对于一些设置了过期时间的key，如果这些key可能会在某些时间点被超高并发地访问，是一种费用“热点”的数据。</p><p>如果这个key在大量请求同时进来前正好失效，那么所有对这个key的数据查询都落到DB上，我们称为缓存击穿。</p><p>解决方案：</p><p>加锁</p><p>大量并发只让一个去查，其他人等待，查到以后释放锁，其它人获取到锁，先差缓存，就会有数据了，而不用去DB查询。</p><p>总结：</p><p>1、解决缓存穿透：空结果也缓存。</p><p>2、解决缓存雪崩：设置过期时间(随机值)。</p><p>3、解决缓存击穿：加锁。</p><p>例如：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>ops<span style=color:#f92672>.</span><span style=color:#a6e22e>set</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;RecordData&#34;</span><span style=color:#f92672>,</span><span style=color:#66d9ef>null</span><span style=color:#f92672>,</span> <span style=color:#ae81ff>1</span><span style=color:#f92672>,</span> TimeUnit<span style=color:#f92672>.</span><span style=color:#a6e22e>DAYS</span><span style=color:#f92672>);</span>   <span style=color:#75715e>//null值也缓存
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>ops<span style=color:#f92672>.</span><span style=color:#a6e22e>set</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;RecordData&#34;</span><span style=color:#f92672>,</span>JSON<span style=color:#f92672>.</span><span style=color:#a6e22e>toJSONString</span><span style=color:#f92672>(</span>recordEntity<span style=color:#f92672>),</span> <span style=color:#ae81ff>1</span><span style=color:#f92672>,</span> TimeUnit<span style=color:#f92672>.</span><span style=color:#a6e22e>DAYS</span><span style=color:#f92672>);</span>
</span></span></code></pre></div><p>解锁：</p><p>1、通过synchronized/Lock本地锁。</p><p>2、分布式锁解决方案Redisson。</p><p>但是本地锁synchronized/Lock不能解决分布式带来的击穿问题。因此分布式还得用Redisson进行加锁解决。</p><p>redisson分布式锁，可参考另一篇redisson分布式锁。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>    <span style=color:#75715e>//本地加锁
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>public</span> RecordEntity <span style=color:#a6e22e>getEntityByIdByRedis</span><span style=color:#f92672>(</span>Long id<span style=color:#f92672>){</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>synchronized</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>){</span>
</span></span><span style=display:flex><span>            ValueOperations<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>,</span> String<span style=color:#f92672>&gt;</span> ops <span style=color:#f92672>=</span> redisTemplate<span style=color:#f92672>.</span><span style=color:#a6e22e>opsForValue</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>            String recordData <span style=color:#f92672>=</span> ops<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;RecordData&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span><span style=color:#f92672>(</span>recordData<span style=color:#f92672>!=</span><span style=color:#66d9ef>null</span><span style=color:#f92672>){</span>
</span></span><span style=display:flex><span>                System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;从数据库查询数据之前，有缓存数据。。。。&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> JSON<span style=color:#f92672>.</span><span style=color:#a6e22e>parseObject</span><span style=color:#f92672>(</span>recordData<span style=color:#f92672>,</span> <span style=color:#66d9ef>new</span> TypeReference<span style=color:#f92672>&lt;</span>RecordEntity<span style=color:#f92672>&gt;()</span> <span style=color:#f92672>{});</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>            System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;从数据库查询数据....&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            RecordEntity recordEntity <span style=color:#f92672>=</span> baseMapper<span style=color:#f92672>.</span><span style=color:#a6e22e>selectById</span><span style=color:#f92672>(</span>id<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            ops<span style=color:#f92672>.</span><span style=color:#a6e22e>set</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;RecordData&#34;</span><span style=color:#f92672>,</span>JSON<span style=color:#f92672>.</span><span style=color:#a6e22e>toJSONString</span><span style=color:#f92672>(</span>recordEntity<span style=color:#f92672>),</span> <span style=color:#ae81ff>1</span><span style=color:#f92672>,</span> TimeUnit<span style=color:#f92672>.</span><span style=color:#a6e22e>DAYS</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> recordEntity<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>//redis分布式锁
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>public</span> RecordEntity <span style=color:#a6e22e>getEntityByIdByFbs</span><span style=color:#f92672>(</span>Long id<span style=color:#f92672>){</span>
</span></span><span style=display:flex><span>        String uuid <span style=color:#f92672>=</span> UUID<span style=color:#f92672>.</span><span style=color:#a6e22e>randomUUID</span><span style=color:#f92672>().</span><span style=color:#a6e22e>toString</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        ValueOperations<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>,</span> String<span style=color:#f92672>&gt;</span> ops <span style=color:#f92672>=</span> redisTemplate<span style=color:#f92672>.</span><span style=color:#a6e22e>opsForValue</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>//保证原子性，加锁同时设置过期时间
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        Boolean lock <span style=color:#f92672>=</span> ops<span style=color:#f92672>.</span><span style=color:#a6e22e>setIfAbsent</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;lock&#34;</span><span style=color:#f92672>,</span> uuid<span style=color:#f92672>,</span> <span style=color:#ae81ff>30</span><span style=color:#f92672>,</span> TimeUnit<span style=color:#f92672>.</span><span style=color:#a6e22e>SECONDS</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span><span style=color:#f92672>(</span>lock<span style=color:#f92672>){</span>
</span></span><span style=display:flex><span>            System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;获取分布式锁成功。。。。。&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            RecordEntity recordEntity <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>try</span><span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                recordEntity <span style=color:#f92672>=</span> getEntityById<span style=color:#f92672>(</span>id<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span><span style=color:#66d9ef>finally</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#75715e>//删除锁保证原子性，使用脚本
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                String script <span style=color:#f92672>=</span><span style=color:#e6db74>&#34;if redis.call(\&#34;get\&#34;,KEYS[1]) == ARGV[1]\n&#34;</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>                        <span style=color:#e6db74>&#34;then\n&#34;</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>                        <span style=color:#e6db74>&#34;    return redis.call(\&#34;del\&#34;,KEYS[1])\n&#34;</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>                        <span style=color:#e6db74>&#34;else\n&#34;</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>                        <span style=color:#e6db74>&#34;    return 0\n&#34;</span> <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>                        <span style=color:#e6db74>&#34;end&#34;</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                Long lock1 <span style=color:#f92672>=</span> redisTemplate<span style=color:#f92672>.</span><span style=color:#a6e22e>execute</span><span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> DefaultRedisScript<span style=color:#f92672>&lt;</span>Long<span style=color:#f92672>&gt;(</span>script<span style=color:#f92672>,</span> Long<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>),</span> Arrays<span style=color:#f92672>.</span><span style=color:#a6e22e>asList</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;lock&#34;</span><span style=color:#f92672>),</span> uuid<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> recordEntity<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span><span style=color:#66d9ef>else</span><span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;获取分布式锁失败，等待重试。。。。&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>//重试，可以等待sleep一下
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>try</span><span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                Thread<span style=color:#f92672>.</span><span style=color:#a6e22e>sleep</span><span style=color:#f92672>(</span><span style=color:#ae81ff>200</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span><span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>Exception e<span style=color:#f92672>){</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> getEntityByIdByFbs<span style=color:#f92672>(</span>id<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>//业务代码
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>public</span> RecordEntity <span style=color:#a6e22e>getEntityById</span><span style=color:#f92672>(</span>Long id<span style=color:#f92672>){</span>
</span></span><span style=display:flex><span>        ValueOperations<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>,</span> String<span style=color:#f92672>&gt;</span> ops <span style=color:#f92672>=</span> redisTemplate<span style=color:#f92672>.</span><span style=color:#a6e22e>opsForValue</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        String recordData <span style=color:#f92672>=</span> ops<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;RecordData&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span><span style=color:#f92672>(</span>recordData<span style=color:#f92672>!=</span><span style=color:#66d9ef>null</span><span style=color:#f92672>){</span>
</span></span><span style=display:flex><span>            System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;从数据库查询数据之前，有缓存数据。。。。&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> JSON<span style=color:#f92672>.</span><span style=color:#a6e22e>parseObject</span><span style=color:#f92672>(</span>recordData<span style=color:#f92672>,</span> <span style=color:#66d9ef>new</span> TypeReference<span style=color:#f92672>&lt;</span>RecordEntity<span style=color:#f92672>&gt;()</span> <span style=color:#f92672>{});</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;从数据库查询数据....&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        RecordEntity recordEntity <span style=color:#f92672>=</span> baseMapper<span style=color:#f92672>.</span><span style=color:#a6e22e>selectById</span><span style=color:#f92672>(</span>id<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        ops<span style=color:#f92672>.</span><span style=color:#a6e22e>set</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;RecordData&#34;</span><span style=color:#f92672>,</span>JSON<span style=color:#f92672>.</span><span style=color:#a6e22e>toJSONString</span><span style=color:#f92672>(</span>recordEntity<span style=color:#f92672>),</span> <span style=color:#ae81ff>1</span><span style=color:#f92672>,</span> TimeUnit<span style=color:#f92672>.</span><span style=color:#a6e22e>DAYS</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> recordEntity<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>//Redisson分布式锁
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>public</span> RecordEntity <span style=color:#a6e22e>getEntityByIdByFbsRedisson</span><span style=color:#f92672>(</span>Long id<span style=color:#f92672>){</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>//保证原子性，加锁同时设置过期时间
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        RLock lock <span style=color:#f92672>=</span> redissonClient<span style=color:#f92672>.</span><span style=color:#a6e22e>getLock</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;RecordData-lock&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        lock<span style=color:#f92672>.</span><span style=color:#a6e22e>lock</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        RecordEntity recordEntity <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;获取分布式锁成功。。。。。&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            recordEntity <span style=color:#f92672>=</span> getEntityById<span style=color:#f92672>(</span>id<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span><span style=color:#66d9ef>finally</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;释放锁成功。。。。。&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            lock<span style=color:#f92672>.</span><span style=color:#a6e22e>unlock</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> recordEntity<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>//    使用缓存注解方式
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Cacheable</span><span style=color:#f92672>(</span>value <span style=color:#f92672>=</span> <span style=color:#f92672>{</span><span style=color:#e6db74>&#34;record&#34;</span><span style=color:#f92672>},</span>key <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;#root.method.name&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> RecordEntity <span style=color:#a6e22e>getRecordAllInfoById</span><span style=color:#f92672>(</span>Long id<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>//未使用注解缓存方案
</span></span></span><span style=display:flex><span><span style=color:#75715e>//        RecordEntity recordEntity = null;
</span></span></span><span style=display:flex><span><span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e>//        ValueOperations&lt;String, String&gt; forValue = redisTemplate.opsForValue();
</span></span></span><span style=display:flex><span><span style=color:#75715e>//        String recordData = forValue.get(&#34;RecordData&#34;);
</span></span></span><span style=display:flex><span><span style=color:#75715e>//        if(recordData==null){
</span></span></span><span style=display:flex><span><span style=color:#75715e>//            System.out.println(&#34;缓存没数据,执行查询数据库方法。。。。&#34;);
</span></span></span><span style=display:flex><span><span style=color:#75715e>//            recordEntity = getEntityByIdByFbsRedisson(id);
</span></span></span><span style=display:flex><span><span style=color:#75715e>//        }else{
</span></span></span><span style=display:flex><span><span style=color:#75715e>//            System.out.println(&#34;从缓存中获取数据。。。。。&#34;);
</span></span></span><span style=display:flex><span><span style=color:#75715e>//            recordEntity = JSON.parseObject(recordData, new TypeReference&lt;RecordEntity&gt;() {
</span></span></span><span style=display:flex><span><span style=color:#75715e>//            });
</span></span></span><span style=display:flex><span><span style=color:#75715e>//        }
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>//使用注解缓存后
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        RecordEntity recordEntity <span style=color:#f92672>=</span> getEntityById<span style=color:#f92672>(</span>id<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span><span style=color:#f92672>(</span>recordEntity<span style=color:#f92672>!=</span><span style=color:#66d9ef>null</span><span style=color:#f92672>){</span>
</span></span><span style=display:flex><span>            Long categoryId <span style=color:#f92672>=</span> recordEntity<span style=color:#f92672>.</span><span style=color:#a6e22e>getCategoryId</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>            Long<span style=color:#f92672>[]</span> catelogPath <span style=color:#f92672>=</span> findCatelogPath<span style=color:#f92672>(</span>categoryId<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            recordEntity<span style=color:#f92672>.</span><span style=color:#a6e22e>setCatelogPath</span><span style=color:#f92672>(</span>catelogPath<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> recordEntity<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span></code></pre></div><h1 id=利用redis的set-nx实现分布式>利用redis的set NX实现分布式</h1><p><img src=https://cdn.jsdelivr.net/gh/willxwu/CDN@main/images/202203032221812.png alt></p><p>redisson分布式锁，实现原理就是利用redis的set nx实现的。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>SET key value <span style=color:#f92672>[</span>EX seconds<span style=color:#f92672>]</span> <span style=color:#f92672>[</span>PX milliseconds<span style=color:#f92672>]</span> <span style=color:#f92672>[</span>NX<span style=color:#f92672>|</span>XX<span style=color:#f92672>]</span>
</span></span></code></pre></div><p><img src=https://cdn.jsdelivr.net/gh/willxwu/CDN@main/images/202203032221730.png alt></p><p>分布式锁原理可以看<a href=http://redis.cn/commands/set.html>redis官方文档set nx命令</a>。</p><p>更多分布式锁可参考，另一个篇springboot整合分布式锁redisson。</p></div><div class=post-footer></div></article></main></body></html>