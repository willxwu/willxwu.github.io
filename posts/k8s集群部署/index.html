<!doctype html><html lang=en-us><head><title>// willxwu</title><link rel="shortcut icon" href=/favicon.ico><meta charset=utf-8><meta name=generator content="Hugo 0.111.3"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="John Doe"><meta name=description content><link rel=stylesheet href=https://willxwu.github.io/css/main.min.68e582a4d4ed824d6b7e3b5b37cae47eb3779bd631046379d0e68b38230cc3e2.css><meta name=twitter:card content="summary"><meta name=twitter:title content><meta name=twitter:description content="K8S集群部署
一、虚拟机搭建 通过Oracle VM VirtualBox，Vagrant搭建三台虚拟机。
1、修改Vagrantfile文件，批量创建3台虚拟机，内容如下：该文件是放在个人用户名文件夹下的。
Vagrant.configure(&#34;2&#34;) do |config| (1..3).each do |i| config.vm.define &#34;k8s-node#{i}&#34; do |node| # 设置虚拟机的Box node.vm.box = &#34;centos/7&#34; config.vm.box_url = &#34;https://mirrors.ustc.edu.cn/centos-cloud/centos/7/vagrant/x86_64/images/CentOS-7.box&#34; # 设置虚拟机的主机名 node.vm.hostname=&#34;k8s-node#{i}&#34; # 设置虚拟机的IP node.vm.network &#34;private_network&#34;, ip: &#34;192.168.56.#{99+i}&#34;, netmask: &#34;255.255.255.0&#34; # 设置主机与虚拟机的共享目录 # node.vm.synced_folder &#34;~/Documents/vagrant/share&#34;, &#34;/home/vagrant/share&#34; # VirtaulBox相关配置 node.vm.provider &#34;virtualbox&#34; do |v| # 设置虚拟机的名称 v.name = &#34;k8s-node#{i}&#34; # 设置虚拟机的内存大小 v.memory = 2048 # 设置虚拟机的CPU个数 v.cpus = 4 end end end end 注意一个细节，如果一次卡在文件复制过程中，检查是否复制了全部个人目录下数据。如果是请修改Vagrantfile文件：
C:\Users\自己用户名\.vagrant.d\boxes\centos-VAGRANTSLASH-7\0\virtualbox\Vagrantfile Vagrant.configure(&#34;2&#34;) do |config| config."><meta property="og:title" content><meta property="og:description" content="K8S集群部署
一、虚拟机搭建 通过Oracle VM VirtualBox，Vagrant搭建三台虚拟机。
1、修改Vagrantfile文件，批量创建3台虚拟机，内容如下：该文件是放在个人用户名文件夹下的。
Vagrant.configure(&#34;2&#34;) do |config| (1..3).each do |i| config.vm.define &#34;k8s-node#{i}&#34; do |node| # 设置虚拟机的Box node.vm.box = &#34;centos/7&#34; config.vm.box_url = &#34;https://mirrors.ustc.edu.cn/centos-cloud/centos/7/vagrant/x86_64/images/CentOS-7.box&#34; # 设置虚拟机的主机名 node.vm.hostname=&#34;k8s-node#{i}&#34; # 设置虚拟机的IP node.vm.network &#34;private_network&#34;, ip: &#34;192.168.56.#{99+i}&#34;, netmask: &#34;255.255.255.0&#34; # 设置主机与虚拟机的共享目录 # node.vm.synced_folder &#34;~/Documents/vagrant/share&#34;, &#34;/home/vagrant/share&#34; # VirtaulBox相关配置 node.vm.provider &#34;virtualbox&#34; do |v| # 设置虚拟机的名称 v.name = &#34;k8s-node#{i}&#34; # 设置虚拟机的内存大小 v.memory = 2048 # 设置虚拟机的CPU个数 v.cpus = 4 end end end end 注意一个细节，如果一次卡在文件复制过程中，检查是否复制了全部个人目录下数据。如果是请修改Vagrantfile文件：
C:\Users\自己用户名\.vagrant.d\boxes\centos-VAGRANTSLASH-7\0\virtualbox\Vagrantfile Vagrant.configure(&#34;2&#34;) do |config| config."><meta property="og:type" content="article"><meta property="og:url" content="https://willxwu.github.io/posts/k8s%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2/"><meta property="article:section" content="posts"></head><body><header class=app-header><a href=https://willxwu.github.io/><img class=app-header-avatar src=/avatar.jpg alt="John Doe"></a><h1>willxwu</h1><nav class=app-header-menu><a class=app-header-menu-item href=/about/>about</a>
-
<a class=app-header-menu-item href=/>home</a>
-
<a class=app-header-menu-item href=/link/>link</a>
-
<a class=app-header-menu-item href=/tags/>tags</a></nav><p>I write code and I take care about my privacy // Co-founder @ Owaka // Golang lover // Open source enthusiast</p><div class=app-header-social><a target=_blank href=https://github.com/willxwu rel="noreferrer noopener"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-github"><title>github</title><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a><a target=_blank href=https://twitter.com/willxwu rel="noreferrer noopener"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-twitter"><title>twitter</title><path d="M23 3a10.9 10.9.0 01-3.14 1.53 4.48 4.48.0 00-7.86 3v1A10.66 10.66.0 013 4s-4 9 5 13a11.64 11.64.0 01-7 2c9 5 20 0 20-11.5a4.5 4.5.0 00-.08-.83A7.72 7.72.0 0023 3z"/></svg></a></div></header><main class=app-container><article class=post><header class=post-header><h1 class=post-title></h1><div class=post-meta><div><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-calendar"><title>calendar</title><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>Jan 1, 0001</div><div><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-clock"><title>clock</title><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>4 min read</div></div></header><div class=post-content><p>K8S集群部署</p><h1 id=一虚拟机搭建>一、虚拟机搭建</h1><p>通过Oracle VM VirtualBox，Vagrant搭建三台虚拟机。</p><p><strong>1、修改Vagrantfile文件，批量创建3台虚拟机</strong>，内容如下：该文件是放在个人用户名文件夹下的。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>Vagrant.configure<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;2&#34;</span><span style=color:#f92672>)</span> <span style=color:#66d9ef>do</span> |config|
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>   <span style=color:#f92672>(</span>1..3<span style=color:#f92672>)</span>.each <span style=color:#66d9ef>do</span> |i|
</span></span><span style=display:flex><span>        config.vm.define <span style=color:#e6db74>&#34;k8s-node#{i}&#34;</span> <span style=color:#66d9ef>do</span> |node|
</span></span><span style=display:flex><span>            <span style=color:#75715e># 设置虚拟机的Box</span>
</span></span><span style=display:flex><span>            node.vm.box <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;centos/7&#34;</span>
</span></span><span style=display:flex><span>            config.vm.box_url <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;https://mirrors.ustc.edu.cn/centos-cloud/centos/7/vagrant/x86_64/images/CentOS-7.box&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#75715e># 设置虚拟机的主机名</span>
</span></span><span style=display:flex><span>            node.vm.hostname<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;k8s-node#{i}&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#75715e># 设置虚拟机的IP</span>
</span></span><span style=display:flex><span>            node.vm.network <span style=color:#e6db74>&#34;private_network&#34;</span>, ip: <span style=color:#e6db74>&#34;192.168.56.#{99+i}&#34;</span>, netmask: <span style=color:#e6db74>&#34;255.255.255.0&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#75715e># 设置主机与虚拟机的共享目录</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e># node.vm.synced_folder &#34;~/Documents/vagrant/share&#34;, &#34;/home/vagrant/share&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#75715e># VirtaulBox相关配置</span>
</span></span><span style=display:flex><span>            node.vm.provider <span style=color:#e6db74>&#34;virtualbox&#34;</span> <span style=color:#66d9ef>do</span> |v|
</span></span><span style=display:flex><span>                <span style=color:#75715e># 设置虚拟机的名称</span>
</span></span><span style=display:flex><span>                v.name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;k8s-node#{i}&#34;</span>
</span></span><span style=display:flex><span>                <span style=color:#75715e># 设置虚拟机的内存大小</span>
</span></span><span style=display:flex><span>                v.memory <span style=color:#f92672>=</span> <span style=color:#ae81ff>2048</span>
</span></span><span style=display:flex><span>                <span style=color:#75715e># 设置虚拟机的CPU个数</span>
</span></span><span style=display:flex><span>                v.cpus <span style=color:#f92672>=</span> <span style=color:#ae81ff>4</span>
</span></span><span style=display:flex><span>            end
</span></span><span style=display:flex><span>        end
</span></span><span style=display:flex><span>   end
</span></span><span style=display:flex><span>end
</span></span></code></pre></div><p><strong>注意一个细节，如果一次卡在文件复制过程中，检查是否复制了全部个人目录下数据。如果是请修改Vagrantfile文件：</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>C:<span style=color:#ae81ff>\U</span>sers<span style=color:#ae81ff>\自</span>己用户名<span style=color:#ae81ff>\.</span>vagrant.d<span style=color:#ae81ff>\b</span>oxes<span style=color:#ae81ff>\c</span>entos-VAGRANTSLASH-7<span style=color:#ae81ff>\0\v</span>irtualbox<span style=color:#ae81ff>\V</span>agrantfile
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>Vagrant.configure<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;2&#34;</span><span style=color:#f92672>)</span> <span style=color:#66d9ef>do</span> |config|
</span></span><span style=display:flex><span>  config.vm.base_mac <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;5254004d77d3&#34;</span>
</span></span><span style=display:flex><span>  config.vm.synced_folder <span style=color:#e6db74>&#34;./.vagrant&#34;</span>, <span style=color:#e6db74>&#34;/vagrant&#34;</span>, type: <span style=color:#e6db74>&#34;rsync&#34;</span>
</span></span><span style=display:flex><span>end
</span></span></code></pre></div><p>.vagrant：为自己用户名下的.vagrant文件夹</p><p><img src=https://cdn.jsdelivr.net/gh/willxwu/CDN@main/images/202203232341989.png alt></p><p>通过cmd命令快速批量生成3台虚拟机：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>vagrant up
</span></span></code></pre></div><p><img src=https://cdn.jsdelivr.net/gh/willxwu/CDN@main/images/202203232344368.png alt></p><p><strong>2、进入三个虚拟机，开启 root 的密码访问权限</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>vagrant ssh k8s-node1
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>su root
</span></span></code></pre></div><p>默认密码vagrant</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>vi /etc/ssh/sshd_config
</span></span></code></pre></div><p>修改配置文件：ChallengeResponseAuthentication为yes</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ChallengeResponseAuthentication yes
</span></span></code></pre></div><p>重启sshd</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>service sshd restart
</span></span></code></pre></div><p><strong>三台虚拟机相同配置。</strong></p><h1 id=二网络配置>二、网络配置</h1><p><strong>1、全局添加网卡</strong></p><p><img src=https://cdn.jsdelivr.net/gh/willxwu/CDN@main/images/202203232347502.png alt></p><p><strong>2、分别为三台虚拟机配置ip地址</strong></p><p>为每台虚拟配置网卡一net网络，并重新生成mac地址。网卡1是实际用的地址，网卡2是用于本地ssh链接到虚拟机的网络。</p><p><img src=https://cdn.jsdelivr.net/gh/willxwu/CDN@main/images/202203232350151.png alt></p><p>三台虚拟同上操作，记得重新生成mac地址。</p><p>设置 linux 环境(三个节点都执行)</p><p>关闭防火墙</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl stop firewalld
</span></span><span style=display:flex><span>systemctl disable firewalld
</span></span></code></pre></div><p>关闭 selinux</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sed -i <span style=color:#e6db74>&#39;s/enforcing/disabled/&#39;</span> /etc/selinux/config
</span></span><span style=display:flex><span>setenforce 
</span></span></code></pre></div><p>关闭 swap</p><p>临时关闭</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>swapoff -a 
</span></span></code></pre></div><p>永久</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sed -ri <span style=color:#e6db74>&#39;s/.*swap.*/#&amp;/&#39;</span> /etc/fstab
</span></span></code></pre></div><p>验证，swap 必须为 0；</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>free -g 
</span></span></code></pre></div><p>添加主机名与 IP 对应关系</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>vi /etc/host
</span></span></code></pre></div><p>添加自己主机net网络ip与虚拟机名字映射：（<strong>注意，重点，ip不要搞错了，是eth0的ip</strong>）</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>10.0.2.15 k8s-node1
</span></span><span style=display:flex><span>10.0.2.4 k8s-node2
</span></span><span style=display:flex><span>10.0.2.5 k8s-node3
</span></span></code></pre></div><p>将桥接的 IPv4 流量传递到 iptables 的链：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cat &gt; /etc/sysctl.d/k8s.conf <span style=color:#e6db74>&lt;&lt; EOF
</span></span></span><span style=display:flex><span><span style=color:#e6db74>net.bridge.bridge-nf-call-ip6tables = 1
</span></span></span><span style=display:flex><span><span style=color:#e6db74>net.bridge.bridge-nf-call-iptables = 1
</span></span></span><span style=display:flex><span><span style=color:#e6db74>EOF</span>
</span></span></code></pre></div><p>重启</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sysctl --syste
</span></span></code></pre></div><p>疑难问题，遇见提示是只读的文件系统，运行如下命令</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>mount -o remount rw
</span></span></code></pre></div><h1 id=三安装k8s环境>三、安装K8S环境</h1><p><strong>所有节点安装 Docker、kubeadm、kubelet、kubectl</strong></p><p><strong>1、安装 docker</strong></p><p>卸载系统之前的 docker</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo yum remove docker <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>docker-client <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>docker-client-latest <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>docker-common <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>docker-latest <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>docker-latest-logrotate <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>docker-logrotate <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>docker-engine
</span></span></code></pre></div><p>安装 Docker-CE</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo yum install -y yum-utils <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>device-mapper-persistent-data <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>lvm2
</span></span></code></pre></div><p>设置 docker repo 的 yum 位置</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo yum-config-manager --add-repo https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo
</span></span></code></pre></div><p>安装 docker，以及 docker-cli</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo yum install -y docker-ce docker-ce-cli containerd.io
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo sed -i <span style=color:#e6db74>&#39;s+download.docker.com+mirrors.aliyun.com/docker-ce+&#39;</span> /etc/yum.repos.d/docker-ce.repo
</span></span></code></pre></div><p>更新并安装Docker-CE</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo yum makecache fast
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo yum install -y docker-ce docker-ce-cli containerd.io
</span></span></code></pre></div><p>配置docker加速</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo mkdir -p /etc/docker
</span></span><span style=display:flex><span>sudo tee /etc/docker/daemon.json <span style=color:#e6db74>&lt;&lt;-&#39;EOF&#39; { &#34;registry-mirrors&#34;: [&#34;https://82m9ar63.mirror.aliyuncs.com&#34;]
</span></span></span><span style=display:flex><span><span style=color:#e6db74>}
</span></span></span><span style=display:flex><span><span style=color:#e6db74>EOF</span>
</span></span><span style=display:flex><span>sudo systemctl daemon-reload
</span></span><span style=display:flex><span>sudo 
</span></span></code></pre></div><p><strong>注意看看daemon.json最后文件是否创建成功，对不对。</strong></p><p>启动 docker & 设置 docker 开机自启</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl enable docke
</span></span></code></pre></div><p>添加阿里云 yum 源</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cat &gt; /etc/yum.repos.d/kubernetes.repo <span style=color:#e6db74>&lt;&lt; EOF
</span></span></span><span style=display:flex><span><span style=color:#e6db74>[kubernetes]
</span></span></span><span style=display:flex><span><span style=color:#e6db74>name=Kubernetes
</span></span></span><span style=display:flex><span><span style=color:#e6db74>baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64
</span></span></span><span style=display:flex><span><span style=color:#e6db74>enabled=1
</span></span></span><span style=display:flex><span><span style=color:#e6db74>gpgcheck=0
</span></span></span><span style=display:flex><span><span style=color:#e6db74>repo_gpgcheck=0
</span></span></span><span style=display:flex><span><span style=color:#e6db74>gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg
</span></span></span><span style=display:flex><span><span style=color:#e6db74>https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg
</span></span></span><span style=display:flex><span><span style=color:#e6db74>EOF</span>
</span></span></code></pre></div><p>安装 kubeadm，kubelet 和 kubectl</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>yum install -y kubelet-1.17.3 kubeadm-1.17.3 kubectl-1.17.3
</span></span></code></pre></div><p>设置开机启动</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl enable kubelet
</span></span><span style=display:flex><span>systemctl start kubelet
</span></span></code></pre></div><p>通过命令查看现在是起不来得，还没配置好。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl status kubelet
</span></span></code></pre></div><h1 id=四部署-k8s-master>四、部署 k8s-master</h1><p>1、master 节点初始化，注意修改为自己master主机地址，我的(10.0.2.15)</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubeadm init <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>--apiserver-advertise-address<span style=color:#f92672>=</span>10.0.2.15 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>--image-repository registry.cn-hangzhou.aliyuncs.com/google_containers <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>--kubernetes-version v1.17.3 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>--service-cidr<span style=color:#f92672>=</span>10.96.0.0/16 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>--pod-network-cidr<span style=color:#f92672>=</span>10.244.0.0/16
</span></span></code></pre></div><p>/root/新建文件夹k8s，然后cd k8s目录，新建master_images.sh文件：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>#!/bin/bash
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>images<span style=color:#f92672>=(</span>
</span></span><span style=display:flex><span>    kube-apiserver:v1.17.3
</span></span><span style=display:flex><span>    kube-proxy:v1.17.3
</span></span><span style=display:flex><span>    kube-controller-manager:v1.17.3
</span></span><span style=display:flex><span>    kube-scheduler:v1.17.3
</span></span><span style=display:flex><span>    coredns:1.6.5
</span></span><span style=display:flex><span>    etcd:3.4.3-0
</span></span><span style=display:flex><span>    pause:3.1
</span></span><span style=display:flex><span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> imageName in <span style=color:#e6db74>${</span>images[@]<span style=color:#e6db74>}</span> ; <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>    docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/$imageName
</span></span><span style=display:flex><span><span style=color:#75715e>#   docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/$imageName  k8s.gcr.io/$imageName</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>done</span>
</span></span></code></pre></div><p>执行脚本：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./master_images.sh
</span></span></code></pre></div><p>执行结果：</p><p><img src=https://cdn.jsdelivr.net/gh/willxwu/CDN@main/images/202203232151846.png alt></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#f92672>[</span>bootstrap-token<span style=color:#f92672>]</span> Using token: zrevjr.nwh8xqynzt2yopdb
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>bootstrap-token<span style=color:#f92672>]</span> Configuring bootstrap tokens, cluster-info ConfigMap, RBAC Roles
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>bootstrap-token<span style=color:#f92672>]</span> configured RBAC rules to allow Node Bootstrap tokens to post CSRs in order <span style=color:#66d9ef>for</span> nodes to get long term certificate credentials
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>bootstrap-token<span style=color:#f92672>]</span> configured RBAC rules to allow the csrapprover controller automatically approve CSRs from a Node Bootstrap Token
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>bootstrap-token<span style=color:#f92672>]</span> configured RBAC rules to allow certificate rotation <span style=color:#66d9ef>for</span> all node client certificates in the cluster
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>bootstrap-token<span style=color:#f92672>]</span> Creating the <span style=color:#e6db74>&#34;cluster-info&#34;</span> ConfigMap in the <span style=color:#e6db74>&#34;kube-public&#34;</span> namespace
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>kubelet-finalize<span style=color:#f92672>]</span> Updating <span style=color:#e6db74>&#34;/etc/kubernetes/kubelet.conf&#34;</span> to point to a rotatable kubelet client certificate and key
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>addons<span style=color:#f92672>]</span> Applied essential addon: CoreDNS
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>addons<span style=color:#f92672>]</span> Applied essential addon: kube-proxy
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Your Kubernetes control-plane has initialized successfully!
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>To start using your cluster, you need to run the following as a regular user:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  mkdir -p $HOME/.kube
</span></span><span style=display:flex><span>  sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
</span></span><span style=display:flex><span>  sudo chown <span style=color:#66d9ef>$(</span>id -u<span style=color:#66d9ef>)</span>:<span style=color:#66d9ef>$(</span>id -g<span style=color:#66d9ef>)</span> $HOME/.kube/config
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>You should now deploy a pod network to the cluster.
</span></span><span style=display:flex><span>Run <span style=color:#e6db74>&#34;kubectl apply -f [podnetwork].yaml&#34;</span> with one of the options listed at:
</span></span><span style=display:flex><span>  https://kubernetes.io/docs/concepts/cluster-administration/addons/
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Then you can join any number of worker nodes by running the following on each as root:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>kubeadm join 10.0.2.15:6443 --token zrevjr.nwh8xqynzt2yopdb <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --discovery-token-ca-cert-hash sha256:500b649b719b910b065659bd3dfac38aa184b9450d37fd2de0e8c0e69840de88 
</span></span></code></pre></div><p>根据提示执行命令：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>mkdir -p $HOME/.kube
</span></span><span style=display:flex><span>sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
</span></span><span style=display:flex><span>sudo chown <span style=color:#66d9ef>$(</span>id -u<span style=color:#66d9ef>)</span>:<span style=color:#66d9ef>$(</span>id -g<span style=color:#66d9ef>)</span> $HOME/.kube/config
</span></span></code></pre></div><p><strong>注意：记录下自己上面的打印信息，后面会用到生成的信息。</strong></p><p><strong>2、安装kube-flannel.yml</strong>，文件地址https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl apply -f kube-flannel.yml
</span></span></code></pre></div><p>查看所有名称空间的 pods</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl get pods --all-namespaces
</span></span></code></pre></div><p><img src=https://cdn.jsdelivr.net/gh/willxwu/CDN@main/images/202203232209078.png alt></p><p>查看节点信息：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl get nodes
</span></span></code></pre></div><p><img src=https://cdn.jsdelivr.net/gh/willxwu/CDN@main/images/202203232213198.png alt></p><p>**3、在 Node2、node3 节点执行，上面生成的证书，**加入：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubeadm join 10.0.2.15:6443 --token zrevjr.nwh8xqynzt2yopdb <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --discovery-token-ca-cert-hash sha256:500b649b719b910b065659bd3dfac38aa184b9450d37fd2de0e8c0e69840de88 
</span></span></code></pre></div><p><img src=https://cdn.jsdelivr.net/gh/willxwu/CDN@main/images/202203232207918.png alt></p><p>再次查看节点信息：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl get nodes
</span></span></code></pre></div><p><img src=https://cdn.jsdelivr.net/gh/willxwu/CDN@main/images/202203232214721.png alt></p><p>监控 pod进度：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>watch kubectl get pod -n kube-system -o wide
</span></span></code></pre></div><p><img src=https://cdn.jsdelivr.net/gh/willxwu/CDN@main/images/202203232217223.png alt></p><p>再次查看节点信息：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl get nodes
</span></span></code></pre></div><p><img src=https://cdn.jsdelivr.net/gh/willxwu/CDN@main/images/202203232223195.png alt></p><p>此时都是Ready状态，整个集群就搭建成功了。</p><p>一个manster+2个node节点。</p><h1 id=五k8s测试>五、K8S测试</h1><p><strong>1、master自动选择哪个节点，部署一个 tomcat。</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl create deployment tomcat6 --image<span style=color:#f92672>=</span>tomcat:6.0.53-jre8
</span></span></code></pre></div><p>说明：</p><p>tomcat6：部署应用名称</p><p>image：镜像</p><p>获取到 tomcat 信息</p><p><img src=https://cdn.jsdelivr.net/gh/willxwu/CDN@main/images/202203232239215.png alt></p><p>查看资源：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl get all
</span></span></code></pre></div><p>查看更详细信息：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl get all -o wide
</span></span></code></pre></div><p><img src=https://cdn.jsdelivr.net/gh/willxwu/CDN@main/images/202203232243017.png alt></p><p>可以看到tomcat部署在了node3节点。</p><p>在node3执行docker命令可以看到tomcat已经执行：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker images
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker ps
</span></span></code></pre></div><p><img src=https://cdn.jsdelivr.net/gh/willxwu/CDN@main/images/202203232245923.png alt></p><p>查看默认命名空间信息：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl get pods
</span></span></code></pre></div><p>查看全部命名空间信息：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl get pods --all-namespaces
</span></span></code></pre></div><p><img src=https://cdn.jsdelivr.net/gh/willxwu/CDN@main/images/202203232250538.png alt></p><p><strong>2、容灾恢复</strong></p><p>node3节点模拟宕机，停掉tomcat应用：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker stop 9f2fad305252
</span></span></code></pre></div><p>会自动再部署一个tomcat容器。</p><p>node3节点直接关机测试模拟宕机。</p><p>查看节点信息node3已经是noready</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl get nodes
</span></span></code></pre></div><p><img src=https://cdn.jsdelivr.net/gh/willxwu/CDN@main/images/202203232256957.png alt></p><p>查看详细信息：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl get pods -o wide
</span></span></code></pre></div><p>此时node2节点已经在拉去创建tomcat镜像创建tomcat了</p><p><img src=https://cdn.jsdelivr.net/gh/willxwu/CDN@main/images/202203232301510.png alt></p><p>node2节点查看docker信息，已经有tomcat了：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker images
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker ps
</span></span></code></pre></div><p><img src=https://cdn.jsdelivr.net/gh/willxwu/CDN@main/images/202203232303724.png alt></p><p>这就是所谓的容灾恢复。</p><p><strong>3、暴露 nginx 访问</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl expose deployment tomcat6 --port<span style=color:#f92672>=</span><span style=color:#ae81ff>80</span> --target-port<span style=color:#f92672>=</span><span style=color:#ae81ff>8080</span> --type<span style=color:#f92672>=</span>NodePort
</span></span></code></pre></div><p>说明：</p><p>Pod 的 80 映射容器的 8080；</p><p>service 会代理 Pod 的 80端口。</p><p><img src=https://cdn.jsdelivr.net/gh/willxwu/CDN@main/images/202203232308480.png alt></p><p>查看服务信息：svc（service的简写）</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl get svc -o wide
</span></span></code></pre></div><p><img src=https://cdn.jsdelivr.net/gh/willxwu/CDN@main/images/202203232310179.png alt></p><p>然后就可以通过http://192.168.56.101:32476/访问了</p><p><img src=https://cdn.jsdelivr.net/gh/willxwu/CDN@main/images/202203232311165.png alt></p><p>查看信息：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl get all
</span></span></code></pre></div><p><img src=https://cdn.jsdelivr.net/gh/willxwu/CDN@main/images/202203232313512.png alt></p><p><strong>4、动态扩容测试</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl scale --replicas<span style=color:#f92672>=</span><span style=color:#ae81ff>3</span> deployment tomcat6
</span></span></code></pre></div><p>扩容了多份，所有无论访问哪个 node 的指定端口，都可以访问到 tomcat6。上面扩容了3个tomcat6.</p><p>查看扩容后情况：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl get pods -o wide
</span></span></code></pre></div><p>查看服务端口信息：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl get svc -o wide
</span></span></code></pre></div><p><img src=https://cdn.jsdelivr.net/gh/willxwu/CDN@main/images/202203232319315.png alt></p><p>此时通过任何节点32476端口都可以访问tomcat了。</p><p>缩容同样可以实现：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl scale --replicas<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> deployment tomcat6
</span></span></code></pre></div><p><strong>5、删除部署</strong></p><p>查看资源信息</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl get all
</span></span></code></pre></div><p><img src=https://cdn.jsdelivr.net/gh/willxwu/CDN@main/images/202203232328916.png alt></p><p>删除整个部署信息</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span> kubectl delete deployment.apps/tomcat6
</span></span></code></pre></div><p>此时再查看</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl get all
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl get pods
</span></span></code></pre></div><p>已经没有tomcat部署信息了</p><p>流程：创建 deployment 会管理 replicas，replicas 控制 pod 数量，有 pod 故障会自动拉起 新的 pod。</p></div><div class=post-footer></div></article></main></body></html>